name: MB52 Login

on:
  workflow_dispatch:
  # Schedule to run at 08:00 and 19:00 Chile time (America/Santiago).
  # GitHub Actions uses UTC for cron - to handle DST changes we schedule both offsets
  # so at least one cron will match the desired local time year-round.
  schedule:
    - cron: '0 11 * * *'  # 08:00 Chile (UTC-3, typical summer time)
    - cron: '0 12 * * *'  # 08:00 Chile (UTC-4, typical winter time)
    - cron: '0 22 * * *'  # 19:00 Chile (UTC-3, typical summer time)
    - cron: '0 23 * * *'  # 19:00 Chile (UTC-4, typical winter time)

# Evita ejecuciones simultaneas del workflow MB52
concurrency:
  group: mb52
  cancel-in-progress: false

jobs:
  test-ui:
    runs-on: [self-hosted, Windows, X64, rpa_ui_55]
    environment: SAP_Jorge

    env:
      # Variables de rutas (deben estar en environment SAP_Jorge o a nivel repo)
      DEPLOY_PATH: ${{ vars.WIN_DEPLOY_PATH }}
      PYTHON_EXE: ${{ vars.WIN_PYTHON_EXE }}
      # Variables SAP desde environment SAP_Jorge
      SYSTEM: ${{ vars.SYSTEM }}
      CLIENT: ${{ vars.CLIENT }}
      USER: ${{ vars.USER }}
      PW: ${{ secrets.PW }}
      LANG: ${{ vars.LANG }}
      # Credenciales para acceso a recursos de red (desde Environment secrets)
      NET_USER: ${{ secrets.NET_USER }}
      NET_PASS: ${{ secrets.NET_PASS }}
      NET_DOMAIN: ${{ vars.NET_DOMAIN }}
      # Credenciales SQL:
      # - `SQL2022_HOST` y `SQL2022_USER` preferentemente están en el Environment `SAP_Jorge` (no son secretos)
      # - Si no están en el Environment, podemos leerlos desde Repository Variables (vars.) como fallback
      # - `SQL2022_PW` es un secret y se mantiene como tal
      SQL2022_HOST: ${{ vars.SQL2022_HOST }}
      SQL2022_USER: ${{ vars.SQL2022_USER }}
      SQL2022_PW: ${{ secrets.SQL2022_PW }}
      TRANSACTION: 
      # Parametros especificos de MB52
      CENTRO: "4100"
      ALMACEN: "4161"
      VARIANTE: "BOTUIPATH"
      RUTA_DESTINO: "\\\\10.156.145.28\\Publico\\RPA\\Retail\\Stock - Base Tiendas"

    steps:
      - name: Descargar Codigo del Repositorio
        uses: actions/checkout@v4

      - name: Ejecutar SAP Bot MB52
        shell: powershell
        run: |
          Write-Host "[INFO] Verificando presencia de variables NET_* en entorno..."
          $hasUser = -not [string]::IsNullOrEmpty($env:NET_USER)
          $hasPass = -not [string]::IsNullOrEmpty($env:NET_PASS)
          $hasDomain = -not [string]::IsNullOrEmpty($env:NET_DOMAIN)
          Write-Host "NET_USER set? $hasUser"
          Write-Host "NET_PASS set? $hasPass"
          Write-Host "NET_DOMAIN set? $hasDomain"
          if (-not ($hasUser -and $hasPass -and $hasDomain)) {
            Write-Error "[ERROR] Faltan variables NET_* en el entorno del job. Abortando."
            exit 1
          }
          Write-Host "[INFO] Variables NET_* presentes. Continuando..."

          # Verificar que las credenciales SQL estén disponibles: HOST/USER en Environment, PW como secret
          Write-Host "[INFO] Verificando presencia de SQL2022_* en Environment/Secrets..."
          $hasSqlHost = -not [string]::IsNullOrEmpty($env:SQL2022_HOST)
          $hasSqlUser = -not [string]::IsNullOrEmpty($env:SQL2022_USER)
          $hasSqlPw = -not [string]::IsNullOrEmpty($env:SQL2022_PW)
          Write-Host "SQL2022_HOST set (env)? $hasSqlHost"
          Write-Host "SQL2022_USER set (env)? $hasSqlUser"
          Write-Host "SQL2022_PW set (secret)? $hasSqlPw"
          if (-not ($hasSqlHost -and $hasSqlUser -and $hasSqlPw)) {
            Write-Error "[ERROR] Faltan credenciales SQL2022: asegure SQL2022_HOST y SQL2022_USER en Environment (SAP_Jorge) y SQL2022_PW como Secret. Aborto para evitar ingesta insegura."
            exit 1
          }

          # Intento: acceder a la unidad mapeada X: (con comillas por espacios)
          try {
            Set-Location "X:\\Publico\\RPA\\Retail\\Stock - Base Tiendas"
            Write-Host "[INFO] Acceso a unidad mapeada X: OK"
            # Volver al deploy path para ejecutar el bot
            Set-Location "$env:DEPLOY_PATH"
          } catch {
            Write-Host "[INFO] Unidad mapeada X: no disponible, usando deploy path"
            Set-Location "$env:DEPLOY_PATH"
          }

          # Ejecutar el bot con variables de entorno
          & "$env:PYTHON_EXE" ".\rpa_desktop_win\sap_bot\main.py"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "[ERROR] Bot fallo con codigo de salida: $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host "[SUCCESS] Bot ejecutado correctamente."
