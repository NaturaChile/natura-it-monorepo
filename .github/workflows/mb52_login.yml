name: MB52 Login

on:
  workflow_dispatch:

jobs:
  test-ui:
    runs-on: [self-hosted, Windows, X64, rpa_ui_55]
    environment: SAP_Jorge

    env:
      # Variables de rutas (deben estar en environment SAP_Jorge o a nivel repo)
      DEPLOY_PATH: ${{ vars.WIN_DEPLOY_PATH }}
      PYTHON_EXE: ${{ vars.WIN_PYTHON_EXE }}
      # Variables SAP desde environment SAP_Jorge
      SYSTEM: ${{ vars.SYSTEM }}
      CLIENT: ${{ vars.CLIENT }}
      USER: ${{ vars.USER }}
      PW: ${{ secrets.PW }}
      LANG: ${{ vars.LANG }}
      TRANSACTION: 
      # Parametros especificos de MB52
      CENTRO: "4100"
      ALMACEN: "4161"
      VARIANTE: "BOTUIPATH"
      RUTA_DESTINO: "\\\\10.156.145.28\\Publico\\RPA\\Retail\\Stock - Base Tiendas"

    steps:
      - name: Descargar Codigo del Repositorio
        uses: actions/checkout@v4

      - name: Ejecutar SAP Bot MB52
        shell: powershell
        run: |
          Write-Host "[INFO] Ejecutando SAP Bot MB52 - Stock de Tiendas..."
          # Intento: acceder a la unidad mapeada X: (con comillas por espacios)
          try {
            Set-Location "X:\\Publico\\RPA\\Retail\\Stock - Base Tiendas"
            Write-Host "[INFO] Acceso a unidad mapeada X: OK"
            # Volver al deploy path para ejecutar el bot
            Set-Location "$env:DEPLOY_PATH"
          } catch {
            Write-Host "[INFO] Unidad mapeada X: no disponible, usando deploy path"
            Set-Location "$env:DEPLOY_PATH"
          }

          # Ejecutar el bot con variables de entorno
          & "$env:PYTHON_EXE" ".\rpa_desktop_win\sap_bot\main.py"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "[ERROR] Bot fallo con codigo de salida: $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host "[SUCCESS] Bot ejecutado correctamente."
