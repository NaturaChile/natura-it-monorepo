name: CD - Deploy Windows Bots (Dev)

on:
  push:
    branches: [ "dev" ]
    paths:
      - 'rpa_desktop_win/**'
      - 'core_shared/**'
      - 'config/**'
      - 'requirements.txt'
      - '.github/workflows/deploy_windows_bots.yml'

jobs:
  deploy:
    runs-on: self-hosted-windows
    
    # Conectamos con el entorno para leer las variables
    environment: 10.156.16.48_WINDOWS

    env:
      DEPLOY_PATH: ${{ vars.WIN_DEPLOY_PATH }}
      PYTHON_EXE: ${{ vars.WIN_PYTHON_EXE }}

    steps:
      - name: Descargar Codigo del Repositorio
        uses: actions/checkout@v4

      - name: Desplegar Archivos en Servidor
        shell: powershell
        run: |
          # Usamos variables de entorno para evitar problemas de parsing
          $dest = "$env:DEPLOY_PATH"
          Write-Host "[INFO] Iniciando despliegue en: $dest"
          
          # 1. Crear directorio si no existe
          if (!(Test-Path -Path $dest)) { 
            New-Item -ItemType Directory -Force -Path $dest | Out-Null
            Write-Host "[OK] Directorio base creado."
          }
          
          # 2. Copiar carpetas clave (Sobrescribiendo)
          Write-Host "[INFO] Copiando RPA Desktop..."
          Copy-Item -Path ".\rpa_desktop_win" -Destination $dest -Recurse -Force
          
          Write-Host "[INFO] Copiando Core Shared..."
          Copy-Item -Path ".\core_shared" -Destination $dest -Recurse -Force
          
          Write-Host "[INFO] Copiando Configuracion..."
          Copy-Item -Path ".\config" -Destination $dest -Recurse -Force
          
          Write-Host "[INFO] Copiando Requirements..."
          Copy-Item -Path ".\requirements.txt" -Destination $dest -Force
          
          Write-Host "[SUCCESS] Archivos copiados exitosamente."

      - name: Instalar y Actualizar Librerias Python
        shell: powershell
        run: |
          Write-Host "[INFO] Verificando dependencias..."
          
          # Nos movemos a la ruta de despliegue
          Set-Location "$env:DEPLOY_PATH"
          
          # Verificamos si Python existe en la ruta indicada por la variable
          if (Test-Path "$env:PYTHON_EXE") {
              Write-Host "[INFO] Python detectado en: $env:PYTHON_EXE"
              & "$env:PYTHON_EXE" -m pip install --upgrade pip
              & "$env:PYTHON_EXE" -m pip install -r requirements.txt
              Write-Host "[SUCCESS] Dependencias instaladas."
          } else {
              Write-Error "[ERROR] No se encontro Python en la ruta: $env:PYTHON_EXE"
              Write-Error "Por favor verifica la variable 'WIN_PYTHON_EXE' en GitHub Settings -> Environments."
              exit 1
          }