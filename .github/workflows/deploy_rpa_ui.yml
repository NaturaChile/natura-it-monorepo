name: CD - Deploy RPA UI (Dev)

on:
  # Ejecución manual desde GitHub Actions
  workflow_dispatch:

  push:
    branches: [ "dev" ]
    paths:
      # Monitorear cambios en RPA Desktop y dependencias compartidas
      - 'rpa_desktop_win/**'
      - 'core_shared/**'
      - 'config/**'
      - 'requirements.txt'
      - '.github/workflows/deploy_rpa_ui.yml'

jobs:
  deploy:
    runs-on: [self-hosted, Windows, X64, rpa_ui_55]
    
    # Environment de GitHub con variables y secretos configurados
    environment: 10.156.16.55

    env:
      DEPLOY_PATH: ${{ vars.WIN_DEPLOY_PATH }}
      PYTHON_EXE: ${{ vars.WIN_PYTHON_EXE }}

    steps:
      # ──────────────────────────────────────────────
      # FASE 1: CI - Integración Continua y Validación
      # ──────────────────────────────────────────────
      - name: Descargar Código del Repositorio
        uses: actions/checkout@v4

      - name: Validar Variables de Entorno
        shell: powershell
        run: |
          Write-Host "[CI] Validando variables del Environment 10.156.16.55..."
          $errores = @()

          if ([string]::IsNullOrEmpty("$env:DEPLOY_PATH"))  { $errores += "WIN_DEPLOY_PATH" }
          if ([string]::IsNullOrEmpty("$env:PYTHON_EXE"))   { $errores += "WIN_PYTHON_EXE" }

          if ($errores.Count -gt 0) {
            Write-Error "[ERROR] Variables faltantes en Environment: $($errores -join ', ')"
            exit 1
          }
          Write-Host "[OK] Todas las variables estan configuradas."

      - name: Verificar Python y Sintaxis del Código
        shell: powershell
        run: |
          Write-Host "[CI] Verificando Python..."
          if (!(Test-Path "$env:PYTHON_EXE")) {
            Write-Error "[ERROR] Python no encontrado en: $env:PYTHON_EXE"
            exit 1
          }
          $ver = & "$env:PYTHON_EXE" --version 2>&1
          Write-Host "[OK] $ver"

          Write-Host "[CI] Verificando sintaxis de archivos Python..."
          $archivos = Get-ChildItem -Path ".\rpa_desktop_win" -Filter "*.py" -Recurse
          $fallos = 0
          foreach ($f in $archivos) {
            $result = & "$env:PYTHON_EXE" -m py_compile $f.FullName 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "[FAIL] $($f.FullName): $result"
              $fallos++
            }
          }
          if ($fallos -gt 0) {
            Write-Error "[ERROR] $fallos archivo(s) con errores de sintaxis."
            exit 1
          }
          Write-Host "[OK] Todos los archivos compilan correctamente."

      - name: Instalar/Actualizar Librerías Python
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          Write-Host "[CI] Instalando dependencias..."
          & "$env:PYTHON_EXE" -m pip install --upgrade pip --quiet --no-warn-script-location

          # Librerías generales del monorepo
          & "$env:PYTHON_EXE" -m pip install -r requirements.txt --quiet --no-warn-script-location

          # Dependencias específicas de playwright para gera_bot_cobranza
          & "$env:PYTHON_EXE" -m pip install playwright --quiet --no-warn-script-location
          & "$env:PYTHON_EXE" -m playwright install chromium 2>&1 | ForEach-Object { "$_" }

          Write-Host "[OK] Dependencias instaladas."

      # ──────────────────────────────────────────────
      # FASE 2: CD - Despliegue Continuo
      # ──────────────────────────────────────────────
      - name: Detener Bots Activos (Liberar archivos)
        shell: powershell
        run: |
          Write-Host "[CD] Intentando detener procesos Python antiguos..."
          try {
            Stop-Process -Name "python" -Force -ErrorAction SilentlyContinue
            Write-Host "[OK] Procesos Python detenidos."
          } catch {
            Write-Host "[INFO] No habia procesos corriendo."
          }
          Start-Sleep -Seconds 2

      - name: Desplegar Archivos en Servidor
        shell: powershell
        run: |
          $dest = "$env:DEPLOY_PATH"
          Write-Host "[CD] Iniciando despliegue RPA UI en: $dest"
          
          # 1. Crear directorio base si no existe
          if (!(Test-Path -Path $dest)) { 
            New-Item -ItemType Directory -Force -Path $dest | Out-Null
            Write-Host "[OK] Directorio base creado."
          }
          
          # 2. Copiar carpetas (Sobrescribiendo)
          Write-Host "[CD] Copiando RPA Desktop..."
          Copy-Item -Path ".\rpa_desktop_win" -Destination $dest -Recurse -Force
          
          Write-Host "[CD] Copiando Core Shared..."
          Copy-Item -Path ".\core_shared" -Destination $dest -Recurse -Force
          
          Write-Host "[CD] Copiando Configuracion..."
          if (Test-Path ".\config") {
            Copy-Item -Path ".\config" -Destination $dest -Recurse -Force
          }
          
          Write-Host "[CD] Copiando Requirements..."
          Copy-Item -Path ".\requirements.txt" -Destination $dest -Force
          
          Write-Host "[SUCCESS] Archivos copiados exitosamente."

      - name: Verificar e Instalar ODBC Driver 17
        shell: powershell
        run: |
          Write-Host "[CD] Verificando ODBC Driver 17 for SQL Server..."
          $driverName = "ODBC Driver 17 for SQL Server"
          $installed = Get-OdbcDriver | Where-Object { $_.Name -eq $driverName }

          if ($installed) {
            Write-Host "[OK] El driver ya esta instalado."
          } else {
            Write-Host "[WARN] Driver no encontrado. Iniciando instalacion automatica..."
            $url = "https://go.microsoft.com/fwlink/?linkid=2137251"
            $out = "$env:TEMP\msodbcsql.msi"
            Invoke-WebRequest -Uri $url -OutFile $out
            Start-Process msiexec.exe -ArgumentList "/i $out /quiet /norestart IACCEPTMSODBCSQLLICENSETERMS=YES" -Wait
            Write-Host "[OK] Instalacion completada."
          }

      - name: Validación Post-Despliegue
        shell: powershell
        run: |
          Write-Host "[CD] Verificando despliegue..."
          $dest = "$env:DEPLOY_PATH"
          
          $carpetas = @("rpa_desktop_win", "core_shared", "config")
          foreach ($c in $carpetas) {
            $ruta = Join-Path $dest $c
            if (Test-Path $ruta) {
              Write-Host "[OK] $c desplegado correctamente."
            } else {
              Write-Error "[ERROR] $c NO se encontro en $dest"
              exit 1
            }
          }
          
          Write-Host ""
          Write-Host "========================================="
          Write-Host "[SUCCESS] Despliegue completado"
          Write-Host "  Servidor: rpa_ui_55 (10.156.16.55)"
          Write-Host "  Ruta:     $dest"
          Write-Host "=========================================
