# ──────────────────────────────────────────────
# GitHub Actions – Build, Test & Deploy GSP Bot v5
# ──────────────────────────────────────────────
# Secrets required in GitHub repo settings:
#   GSP_USER_CODE       → Código de supervisor GSP
#   GSP_PASSWORD         → Password de supervisor GSP
#   POSTGRES_PASSWORD    → Password para PostgreSQL
#   DEPLOY_HOST          → IP/hostname del servidor (opcional, solo para deploy remoto)
#   DEPLOY_USER          → Usuario SSH del servidor (opcional)
#   DEPLOY_SSH_KEY       → Llave SSH privada (opcional)
# ──────────────────────────────────────────────

name: Deploy GSP Bot

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  # ── Build & Validate ──────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from GitHub Secrets
        run: |
          # Detect proxy settings from runner environment
          DETECTED_HTTP_PROXY="${HTTP_PROXY:-${http_proxy:-}}"
          DETECTED_HTTPS_PROXY="${HTTPS_PROXY:-${https_proxy:-}}"
          DETECTED_NO_PROXY="${NO_PROXY:-${no_proxy:-}}"
          
          echo "Detected proxy configuration:"
          echo "  HTTP_PROXY: ${DETECTED_HTTP_PROXY:-<not set>}"
          echo "  HTTPS_PROXY: ${DETECTED_HTTPS_PROXY:-<not set>}"
          echo "  NO_PROXY: ${DETECTED_NO_PROXY:-<not set>}"
          
          cat > .env << EOF
          APP_ENV=production
          LOG_LEVEL=INFO
          LOG_FORMAT=json
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_DB=0
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_DB=gsp_bot
          POSTGRES_USER=gsp
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          # Leave CELERY urls unset so docker-compose interpolation uses the
          # \`x-common-env\` defaults in docker-compose.yml which already provide
          # a safe fallback (uses \${REDIS_PASSWORD:-clave}).
          CELERY_CONCURRENCY=3
          CELERY_MAX_RETRIES=3
          CELERY_RETRY_DELAY=30
          GSP_LOGIN_URL=https://natura-auth.prd.naturacloud.com/?company=natura&client_id=3ec6rhfe52b2k78h32kv7ml6ti&redirect_uri=https://gsp.natura.com&country=CL&language=es
          GSP_USER_CODE=${{ secrets.GSP_USER_CODE }}
          GSP_PASSWORD=${{ secrets.GSP_PASSWORD }}
          PLAYWRIGHT_HEADLESS=true
          PLAYWRIGHT_TIMEOUT=60000
          PLAYWRIGHT_SLOW_MO=100
          SCREENSHOT_ON_ERROR=true
          SCREENSHOT_DIR=/app/screenshots
          API_HOST=0.0.0.0
          API_PORT=8000
          FLOWER_PORT=5555
          FLOWER_BASIC_AUTH=admin:changeme
          HTTP_PROXY=${DETECTED_HTTP_PROXY}
          HTTPS_PROXY=${DETECTED_HTTPS_PROXY}
          http_proxy=${DETECTED_HTTP_PROXY}
          https_proxy=${DETECTED_HTTPS_PROXY}
          NO_PROXY=${DETECTED_NO_PROXY:-localhost,127.0.0.1,postgres,redis,master,dispatcher}
          no_proxy=${DETECTED_NO_PROXY:-localhost,127.0.0.1,postgres,redis,master,dispatcher}
          EOF

      - name: Build Docker images
        run: docker-compose build

      - name: Verify images built
        run: docker images | grep gsp

  # ── Deploy (opcional - solo si configuras servidor) ──
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        if: ${{ secrets.DEPLOY_HOST != '' }}
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ~/gsp_v5 || git clone ${{ github.server_url }}/${{ github.repository }}.git ~/gsp_v5
            cd ~/gsp_v5
            git pull origin main

            # Crear .env con secretos
            cat > .env << 'ENVEOF'
            APP_ENV=production
            LOG_LEVEL=INFO
            LOG_FORMAT=json
            REDIS_HOST=redis
            REDIS_PORT=6379
            REDIS_DB=0
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            POSTGRES_HOST=postgres
            POSTGRES_PORT=5432
            POSTGRES_DB=gsp_bot
            POSTGRES_USER=gsp
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            CELERY_CONCURRENCY=3
            CELERY_MAX_RETRIES=3
            CELERY_RETRY_DELAY=30
            GSP_LOGIN_URL=https://natura-auth.prd.naturacloud.com/?company=natura&client_id=3ec6rhfe52b2k78h32kv7ml6ti&redirect_uri=https://gsp.natura.com&country=CL&language=es
            GSP_USER_CODE=${{ secrets.GSP_USER_CODE }}
            GSP_PASSWORD=${{ secrets.GSP_PASSWORD }}
            PLAYWRIGHT_HEADLESS=true
            PLAYWRIGHT_TIMEOUT=60000
            PLAYWRIGHT_SLOW_MO=100
            SCREENSHOT_ON_ERROR=true
            SCREENSHOT_DIR=/app/screenshots
            API_HOST=0.0.0.0
            API_PORT=8000
            FLOWER_PORT=5555
            FLOWER_BASIC_AUTH=admin:changeme
            ENVEOF
            
            # Detect and append proxy settings from server environment
            if [ -n "$HTTP_PROXY" ] || [ -n "$http_proxy" ]; then
              echo "HTTP_PROXY=${HTTP_PROXY:-${http_proxy}}" >> .env
              echo "http_proxy=${HTTP_PROXY:-${http_proxy}}" >> .env
            fi
            if [ -n "$HTTPS_PROXY" ] || [ -n "$https_proxy" ]; then
              echo "HTTPS_PROXY=${HTTPS_PROXY:-${https_proxy}}" >> .env
              echo "https_proxy=${HTTPS_PROXY:-${https_proxy}}" >> .env
            fi
            if [ -n "$NO_PROXY" ] || [ -n "$no_proxy" ]; then
              echo "NO_PROXY=${NO_PROXY:-${no_proxy}}" >> .env
              echo "no_proxy=${NO_PROXY:-${no_proxy}}" >> .env
            fi
            
            echo "Proxy configuration:"
            grep -i proxy .env || echo "  No proxy configured"

            # Levantar servicios
            docker-compose down
            docker-compose up -d --build
            docker-compose ps
            
            # Capturar logs de startup para diagnosticar crashes
            echo "=== Waiting for containers to start ==="
            sleep 5
            echo "=== Worker-1 logs ==="
            docker-compose logs --tail=100 worker-1 || true
            echo "=== Worker-2 logs ==="
            docker-compose logs --tail=100 worker-2 || true
            echo "=== Worker-3 logs ==="
            docker-compose logs --tail=100 worker-3 || true
            echo "=== Container status ==="
            docker-compose ps
